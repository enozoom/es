var Form={_init:function(){this._select()._button()._textarea()._fileUpload()},_fileUpload:function(){var e=$("#panels .panel.active .uploader");return e.length&&($.getScript("/theme/dmuploader/src/dmuploader.min.js",function(){e.each(function(){Form.Upload._init($(this),$(this).data("action"),$(this).find('input[type="file"]').attr("name"))})}),e.each(function(){var e=$(this).find('input[type="hidden"]').val();e.length&&Form.Upload._preview($(this),e)})),this},_textarea:function(){return $textarea=$("#panels .panel.active textarea:not(.normal)"),$textarea.length&&$textarea.each(function(e){var t=$(this).attr("id");t&&($("#"+t).css({width:920}),UE.delEditor(t),UE.getEditor(t))}),this},_button:function(){return $("#panels .panel.active .es4-form button:not(.fileUpload)").click(function(){Form.Button._click($(this))}),this},_select:function(){$(".select-js").on("change","select",function(){Form.Select._change($(this))});var e=$("#panels .panel.active select[data-pids]");return e.length&&e.each(function(){var e=$(this).data("pids").toString(),t=$(this).parent(".select-js"),n=$(this).data("name");Form.Select._init(t,e,n)}),this},Button:{_click:function(e){var t=e.parents("form"),n=t.attr("action");$.post(n,t.serialize(),function(e){if(Number(e.err))EsAdmin.Tool._resultErr();else{var i=(n+e.id+"/").replace(e.id+"/"+e.id,e.id);t.attr("action",i),EsAdmin.Tool._resultOk()}},"json")}},Select:{container:"",name:"",ids:[],_init:function(e,t,n){this.container=e,this.name=n;var i=e.find("select");t.length>0&&(this.ids=t.split("-")).length>=1?(i.remove(),this._new(0)):(i.find('option[value="0"]').length||i.prepend('<option value="0" selected>请选择</option>'),i.attr("name",n+"[]"),Form.Select._auto(i))},_change:function(e){e.attr("name").replace("[]","");if("undefined"==typeof e.attr("data-pids"))return!1;Form.Select.container=Form.Select.container||e.parent(".select-js"),Form.Select.name=Form.Select.name||e.data("name"),e.nextAll("select").remove();var n=e.val();n>0&&$.get("/esadmin/category/catsbypid/"+e.val(),function(e){if(!Number(e.err)&&e.msg.toString().length){var t=Form.Select._sel();$.each(e.msg,function(e,i){t.append('<option value="'+e+'"'+(e==n?" selected":"")+">"+i+"</option>")}),Form.Select.container.append(t)}},"json")},_new:function(e){if(e>=this.ids.length)return!1;var t=this.ids[e];sid=e+1<this.ids.length?this.ids[e+1]:-1,$.get("/esadmin/category/catsbypid/"+t,function(t){if(!Number(t.err)&&t.msg.toString().length){var n=Form.Select._sel();$.each(t.msg,function(e,t){n.append('<option value="'+e+'"'+(e==sid?" selected":"")+">"+t+"</option>")}),Form.Select.container.append(n)}Form.Select._new(++e)},"json")},_sel:function(){return $('<select name="'+Form.Select.name+'[]"><option value="0">请选择</option></select>')},_auto:function(e){var t=e.parents("form").data("selectauto");(void 0===t||1===t)&&e.trigger("change")}},Upload:{_init:function(e,t,n){e.dmUploader({url:t,fileName:n,dataType:"json",allowedTypes:"*",extFilter:"jpg;png;gif;mp4",onUploadSuccess:function(t,i){var a=i[n][0].url;e.find('input[name="'+n+'-tmp"]').val(a),Form.Upload._preview(e,a)},onUploadError:function(e,t){console.log("上传失败")}})},_preview:function(e,t){var n=t.indexOf(".mp4")>0,i=n?'<video src="'+t+'" height="65" autoplay controls="controls"></video>':'<img src="'+t+'" alt="">';e.next(".preview").html(i)}}};