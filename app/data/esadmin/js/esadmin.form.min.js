var Form={_init:function(){this._select()._button()._textarea()._fileUpload()},_fileUpload:function(){var e=$("#panels .panel.active .uploader");return e.length&&($.getScript("/theme/dmuploader/src/dmuploader.min.js",function(){e.each(function(){Form.Upload._init($(this),$(this).data("action"),$(this).find('input[type="file"]').attr("name"))})}),e.each(function(){var e=$(this).find('input[type="hidden"]').val();e.length&&Form.Upload._preview($(this),e)})),this},_textarea:function(){return $textarea=$("#panels .panel.active textarea:not(.normal)"),$textarea.length&&$textarea.each(function(e){var t=$(this).attr("id");t&&($("#"+t).css({width:920}),UE.delEditor(t),UE.getEditor(t))}),this},_button:function(){return $("#panels .panel.active .es4-form button:not(.fileUpload)").click(function(){Form.Button._click($(this))}),this},_select:function(){$(".select-js").on("change","select",function(){Form.Select._change($(this))});var e=$("#panels .panel.active select[data-pids]");return e.length&&Form.Select._init(e),this},Button:{_click:function(e){var t=e.parents("form"),n=t.attr("action");$.post(n,t.serialize(),function(e){if(Number(e.err))EsAdmin.Tool._resultErr();else{var a=(n+e.id+"/").replace(e.id+"/"+e.id,e.id);t.attr("action",a),EsAdmin.Tool._resultOk()}},"json")}},Select:{_init:function(e){e.each(function(){var e=$(this).parent(".select-js"),t=$(this).data("name"),n=$(this).data("pids").toString().split("-");n.length>1?(e.data("name",t).data("ids",n),$(this).remove(),Form.Select._new(0,e)):$(this).attr("name",t+"[]").prepend('<option value="0" selected>请选择</option>')})},_change:function(e){var t=e.data("name"),n=t&&-1==t.indexOf("[]");if(n&&"undefined"==typeof e.attr("data-pids"))return!1;var a=e.parent(".select-js");t=e.data("name"),e.nextAll("select").remove();var i=e.val();i>0&&$.get("/esadmin/category/catsbypid/"+e.val(),function(e){if(!Number(e.err)&&e.msg.toString().length){var n=Form.Select._sel(t);$.each(e.msg,function(e,t){n.append('<option value="'+e+'"'+(e==i?" selected":"")+">"+t+"</option>")}),a.append(n)}},"json")},_new:function(e,t){var n=t.data("ids");return e>=n.length?!1:void $.get("/esadmin/category/catsbypid/"+n[e],function(a){var i=e+1<n.length?n[e+1]:-1;if(!Number(a.err)&&a.msg.toString().length){var o=Form.Select._sel(t.data("name"));$.each(a.msg,function(e,t){o.append('<option value="'+e+'"'+(e==i?" selected":"")+">"+t+"</option>")}),t.append(o)}Form.Select._new(++e,t)},"json")},_sel:function(e){return $('<select name="'+e+'[]"><option value="0">请选择</option></select>')}},Upload:{_init:function(e,t,n){e.dmUploader({url:t,fileName:n,dataType:"json",allowedTypes:"*",extFilter:"jpg;png;gif;mp4",onUploadSuccess:function(t,a){var i=a[n][0].url;e.find('input[name="'+n+'-tmp"]').val(i),Form.Upload._preview(e,i)},onUploadError:function(e,t){console.log("上传失败")}})},_preview:function(e,t){var n=t.indexOf(".mp4")>0,a=n?'<video src="'+t+'" height="65" autoplay controls="controls"></video>':'<img src="'+t+'" alt="">';e.next(".preview").html(a)}}};